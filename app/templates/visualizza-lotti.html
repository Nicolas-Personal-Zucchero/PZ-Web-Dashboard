{% extends "base.html" %}

{% block title %}Visualizza Lotti - Personal Zucchero{% endblock %}

{% block content %}
<div class="p-4">
    <a href="javascript:history.back()" class="btn btn-light mb-3">
      <i class="bi bi-arrow-left"></i> Torna indietro
    </a>
    <h1>Visualizza Lotti</h1>

    {% if lotti %}
    <div class="mb-3 row g-2">
        <div class="col-md-2">
            <input type="text" class="form-control" id="searchInput" placeholder="Cerca lotto..." maxlength="6">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="tipologiaFilter">
                <option value="">Tutte le tipologie</option>
                {% for t in lotti|map(attribute='tipologia_zucchero')|unique %}
                <option value="{{ t }}">{{ t }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="fornitoreFilter">
                <option value="">Tutti i fornitori</option>
                {% for f in lotti|map(attribute='fornitore')|unique %}
                <option value="{{ f }}">{{ f }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" id="origineFilter">
            <option value="">Tutte le origini</option>
            {% for o in lotti|map(attribute='origine')|unique %}
            <option value="{{ o }}">{{ o }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" id="statoFilter">
            <option value="">Tutti i lotti</option>
            <option value="in_caricamento">Solo lotti in caricamento</option>
            <option value="caricati">Solo lotti caricati</option>
          </select>
        </div>
    </div>

    <div style="max-height: 500px; overflow-y: auto;">
        <ul class="list-group" id="listaLotti">
            <li class="list-group-item bg-light fw-bold static-header">
                <div class="row">
                    <div class="col-md-1">Lotto</div>
                    <div class="col-md-3">Tipologia</div>
                    <div class="col-md-2">Fornitore</div>
                    <div class="col-md-1">DDT</div>
                    <div class="col-md-1">Lotti fornitore</div>
                    <div class="col-md-1">Origine</div>
                    <div class="col-md-2">Data creazione</div>
                    <div class="col-md-1">Scansioni</div>
                </div>
            </li>

            {% for lotto in lotti %}
            <li class="list-group-item">
                <div class="row">
                    <div class="col-md-1"><strong>{{ lotto.lotto }}</strong></div>
                    <div class="col-md-3">{{ lotto.tipologia_zucchero }}</div>
                    <div class="col-md-2">{{ lotto.fornitore }}</div>
                    <div class="col-md-1">{{ lotto.ddt }}</div>
                    <div class="col-md-1">{{ lotto.lotti_fornitore | join(', ') }}</div>
                    <div class="col-md-1">{{ lotto.origine }}</div>
                    <div class="col-md-2">{{ lotto.formatted_time }}</div>
                    <div class="col-md-1">
                      <button class="btn btn-sm btn-primary view-scansioni-btn" 
                              data-scansioni='{{ lotto.scansioni_etichette | tojson | safe }}'>
                          {{ lotto.etichette }}
                      </button>
                      <form method="POST" action="/amministrazione/visualizza_lotti/etichetta" target="_blank">
                        <input type="hidden" name="id_lotto" value="{{ lotto.id }}">
                        <button type="submit" class="btn btn-success btn-sm"><i class="bi bi-filetype-pdf"></i></button>
                      </form>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    <div class="modal fade" id="scansioniModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Scansioni Etichette</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <table class="table table-striped" id="scansioniTable">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Impianto</th>
                  <th>Operatore</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
          </div>
        </div>
      </div>
    </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById('searchInput');
    const tipologiaFilter = document.getElementById('tipologiaFilter');
    const fornitoreFilter = document.getElementById('fornitoreFilter');
    const origineFilter = document.getElementById('origineFilter');
    const statoFilter = document.getElementById('statoFilter');
    const items = document.querySelectorAll('#listaLotti .list-group-item');

    function filterLotti() {
        const searchText = searchInput.value.toLowerCase();
        const tipologia = tipologiaFilter.value.toLowerCase();
        const fornitore = fornitoreFilter.value.toLowerCase();
        const origine = origineFilter.value.toLowerCase();
        const stato = statoFilter.value;

        items.forEach(item => {
            if (item.classList.contains('static-header')) return;

            const lottoId = item.querySelector('.col-md-1 strong')?.textContent.toLowerCase() || '';
            const itemTipologia = item.querySelector('.col-md-3')?.textContent.toLowerCase() || '';
            const itemFornitore = item.querySelector('.col-md-2')?.textContent.toLowerCase() || '';
            const itemOrigine = item.querySelector('.col-md-1:nth-child(6)')?.textContent.toLowerCase() || '';

            // Recupera il numero di scansioni e numero di etichette
            const scansioniCount = JSON.parse(item.querySelector('.view-scansioni-btn')?.dataset.scansioni || '[]').length;
            const totaleEtichette = parseInt(item.querySelector('.view-scansioni-btn')?.textContent.split('/')[1] || '0');

            let statoMatch = true;
            if (stato === 'in_caricamento') {
                statoMatch = scansioniCount < totaleEtichette;
            } else if (stato === 'caricati') {
                statoMatch = scansioniCount === totaleEtichette;
            }

            const match = 
                lottoId.includes(searchText) &&
                (tipologia === '' || itemTipologia === tipologia) &&
                (fornitore === '' || itemFornitore === fornitore) &&
                (origine === '' || itemOrigine === origine) &&
                statoMatch;

            item.style.display = match ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', filterLotti);
    tipologiaFilter.addEventListener('change', filterLotti);
    fornitoreFilter.addEventListener('change', filterLotti);
    origineFilter.addEventListener('change', filterLotti);
    statoFilter.addEventListener('change', filterLotti);

    const scansioniModal = new bootstrap.Modal(document.getElementById('scansioniModal'));
    const scansioniTableBody = document.querySelector('#scansioniTable tbody');

    document.querySelectorAll('.view-scansioni-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const scansioni = JSON.parse(this.dataset.scansioni);

            // Svuota la tabella
            scansioniTableBody.innerHTML = '';

            // Popola la tabella
            scansioni.forEach(s => {
                const row = document.createElement('tr');
                const dateCell = document.createElement('td');
                dateCell.textContent = s.date || '';
                const impiantoCell = document.createElement('td');
                impiantoCell.textContent = s.impianto || '';
                const operatoreCell = document.createElement('td');
                operatoreCell.textContent = s.operatore || '';
                row.append(dateCell, impiantoCell, operatoreCell);
                scansioniTableBody.appendChild(row);
            });

            // Apri il modal
            scansioniModal.show();
        });
    });
});
</script>
{% endblock %}
