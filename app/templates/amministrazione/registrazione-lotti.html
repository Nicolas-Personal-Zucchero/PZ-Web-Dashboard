{% extends "base.html" %}

{% block title %}Registrazione Lotti{% endblock %}

{% block content %}
<div class="p-4">
    <a href="javascript:history.back()" class="btn btn-light mb-3">
        <i class="bi bi-arrow-left"></i> Torna indietro
    </a>
    <h1>Registrazione Lotti</h1>
    <h3>Inserisci i dettagli del lotto</h3>
    <form method="POST" id="lotForm">
        <div class="row mb-3">
            <div class="col-md-3">
                <label for="data" class="form-label">Data</label>
                <input type="date" class="form-control" name="data" id="data" required>
            </div>
            <div class="col-md-3">
                <label for="tipologia" class="form-label">Tipologia prodotto</label>
                <select class="form-select" name="tipologia" id="tipologia" required>
                    <option value="" disabled selected>Seleziona tipologia</option>
                    <option>Zucchero Bianco Semolato</option>
                    <option>Zucchero Bianco Extrafine</option>
                    <option>Zucchero Canna Grezzo</option>
                    <option>Zucchero Canna Barbabietola</option>
                    <option>Zucchero BIO Golden</option>
                    <option>Zucchero BIO White</option>
                </select>
            </div>  
            <div class="col-md-3">
                <label for="fornitore" class="form-label">Fornitore</label>
                <select class="form-select" name="fornitore" id="fornitore" required>
                    <option value="" disabled selected>Seleziona fornitore</option>
                    <option value="ITALIAZUCCHERI">ITALIAZUCCHERI</option>
                    <option value="INAGRA">INAGRA</option>
                    <option value="FASTZUCCHERI">FASTZUCCHERI</option>
                    <option value="GRANDAZUCCHERI">GRANDAZUCCHERI</option>
                    <option value="PININPERO">PININPERO</option>
                </select>
            </div>    
            <div class="col-md-3">
                <label for="ddt" class="form-label">DDT</label>
                <input type="text" class="form-control" name="ddt" id="ddt" placeholder="Inserisci DDT" required>
            </div> 
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <label for="origine" class="form-label">Origine</label>
                <select class="form-select" name="origine" id="origine" required>
                    <option value="" disabled selected>Seleziona origine</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="n_etichette" class="form-label">Numero etichette</label>
                <input type="number" class="form-control" name="n_etichette" id="n_etichette" placeholder="Numero etichette" value="24" min="1" required>
            </div> 
            <div class="col-md-4">
                <label for="note" class="form-label">Note</label>
                <input type="text" class="form-control" name="note" id="note" placeholder="Inserisci note" maxlength="15">
            </div> 
        </div>

        <div class="mb-3">
            <label for="lottiContainer" class="form-label">Lotti fornitore</label>
            <div id="lottiContainer">
                <div class="input-group mb-2">
                    <input type="text" name="lotti[]" class="form-control" placeholder="Lotto 1" required>
                    <!-- <button class="btn btn-outline-danger remove-btn" type="button" tabindex="-1">×</button> -->
                </div>
            </div>
            <button type="button" class="btn btn-secondary btn-sm" id="addLottoBtn">Aggiungi Lotto fornitore</button>
        </div>

        <button type="submit" class="btn btn-primary">Registra Lotto</button>
        <!-- <button type="button" class="btn btn-info" onclick="window.location.href='{{ url_for('amministrazione.visualizza_lotti.index') }}'">
            Visualizza Lotti
        </button> -->
    </form>


    {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} mt-2">{{ message }}</div>
        {% endfor %}
    {% endwith %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Imposta la data di default a oggi
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('data').value = today;

    // Popola select origine con nomi dei paesi
    const origineSelect = document.getElementById('origine');
    fetch('https://restcountries.com/v3.1/all?fields=name,translations')
        .then(response => response.json())
        .then(data => {
            // Ordina alfabeticamente in italiano se disponibile
            data.sort((a, b) => {
                const nameA = a.translations?.ita?.common || a.name.common;
                const nameB = b.translations?.ita?.common || b.name.common;
                return nameA.localeCompare(nameB, 'it');
            });

            // Aggiungi tutti i paesi alla select
            data.forEach(country => {
                const option = document.createElement('option');
                option.value = country.translations?.ita?.common || country.name.common;
                option.textContent = country.translations?.ita?.common || country.name.common;
                origineSelect.appendChild(option);
            });
        })
        .catch(err => console.error('Errore caricamento paesi:', err));

    // Gestione aggiunta/rimozione lotti
    const addLottoBtn = document.getElementById('addLottoBtn');
    const lottiContainer = document.getElementById('lottiContainer');
    let lottoCount = 1;

    addLottoBtn.addEventListener('click', function() {
        lottoCount++;
        const div = document.createElement('div');
        div.classList.add('input-group', 'mb-2');
        div.innerHTML = `
            <input type="text" name="lotti[]" class="form-control" placeholder="Lotto ${lottoCount}" required>
            <button class="btn btn-outline-danger remove-btn" type="button" id="btn${lottoCount}" tabindex="-1">×</button>
        `;
        lottiContainer.appendChild(div);
        div.querySelector("input").focus();
    });

    lottiContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-btn') && lottoCount > 1 && e.target.id == `btn${lottoCount}`) {
            e.target.parentElement.remove();
            lottoCount--;
        }
    });
});
</script>

{% if request.args.get('stampare') %}
<script>
    const lotto = "{{ request.args.get('stampare') }}";
    console.log("lotto");
    console.log(lotto);
    // Apri l'etichetta in una nuova tab
    window.open(`/amministrazione/visualizza_lotti/etichetta?id_lotto=${lotto}`, '_blank');

    // Rimuovi il parametro "stampare" dall'URL senza ricaricare la pagina
    const url = new URL(window.location.href);
    url.searchParams.delete('stampare');
    window.history.replaceState(null, '', url.toString());
</script>
{% endif %}

{% endblock %}
