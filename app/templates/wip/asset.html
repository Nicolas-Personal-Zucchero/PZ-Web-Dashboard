{% extends "base.html" %}
{% block title %}Asset{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Elenco Asset</h2>

    <!-- Pulsante mostra/nascondi form -->
    <button class="btn btn-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#formAsset" aria-expanded="false" aria-controls="formAsset">
        Aggiungi nuovo asset
    </button>

    <!-- Form per aggiunta asset -->
    <div class="collapse" id="formAsset">
        <form method="POST">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="nome" class="form-label">Nome dell'asset</label>
                    <input type="text" class="form-control" name="nome" id="nome" placeholder="Es: Macchina Zucchero 1" required>
                </div>
                <div class="col-md-4">
                    <label for="selectTipologia" class="form-label">Tipologia</label>
                    <select class="form-select" name="tipologia" id="selectTipologia" required>
                        <option value="" disabled selected></option>
                        <option>Macchina</option>
                        <option>Veicolo</option>
                        <option>Oggetto</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="posizione" class="form-label">Posizione</label>
                    <input type="text" class="form-control" name="posizione" id="posizione" placeholder="Reparto produzione" required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="intervallo_manutenzione" class="form-label">Intervallo Manutenzione (giorni)</label>
                    <input type="number" class="form-control" name="intervallo_manutenzione" id="intervallo_manutenzione" placeholder="Es: 365" required>
                </div>
                <div class="col-md-4">
                    <label for="intervallo_pulizia" class="form-label">Intervallo Pulizia (giorni)</label>
                    <input type="number" class="form-control" name="intervallo_pulizia" id="intervallo_pulizia" placeholder="Es: 30" min="0" required>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Inserisci asset</button>
        </form>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} mt-2">{{ message }}</div>
        {% endfor %}
    {% endwith %}

    <!-- Filtro ricerca e tipologia -->
    {% if entries %}
    <hr>
    <h3>Asset presenti nel gestionale:</h3>

    <div class="mb-3 row g-2">
        <div class="col-md-6">
            <input type="text" class="form-control" id="searchInput" placeholder="Cerca asset...">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="tipologiaFilter">
                <option value="">Tutte le tipologie</option>
                {% for t in entries|map(attribute='tipologia')|unique %}
                    <option value="{{ t }}">{{ t }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-light sticky-top">
                <tr>
                    <th>Nome</th>
                    <th>Tipologia</th>
                    <th>Posizione</th>
                    <th>Int. Manutenzione</th>
                    <th>Int. Pulizia</th>
                    <th class="text-end">Apri</th>
                    <th class="text-end">Elimina</th>
                </tr>
            </thead>
            <tbody id="assetList">
                {% for e in entries %}
                <tr>
                    <td><strong>{{ e.nome }}</strong></td>
                    <td>{{ e.tipologia }}</td>
                    <td>{{ e.posizione }}</td>
                    <td>{{ e.intervallo_manutenzione }}</td>
                    <td>{{ e.intervallo_pulizia }}</td>
                    <td class="text-end">
                        <a href="/wip/asset/{{ e.id }}" class="btn btn-primary btn-sm">Apri</a>
                    </td>
                    <td class="text-end">
                        <form method="POST" action="/wip/asset/elimina" onsubmit="return confirm('Sei sicuro di voler eliminare questo asset?');">
                            <input type="hidden" name="asset_id" value="{{ e.id }}">
                            <button type="submit" class="btn btn-danger btn-sm">Elimina</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-muted">Nessun asset registrato.</p>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById('searchInput');
    const tipologiaFilter = document.getElementById('tipologiaFilter');
    const items = document.querySelectorAll('#assetList tr');

    function filterAssets() {
        const searchText = searchInput.value.toLowerCase();
        const tipologia = tipologiaFilter.value.toLowerCase();

        items.forEach(item => {
            const nome = item.children[0]?.textContent.toLowerCase() || '';
            const tipo = item.children[1]?.textContent.toLowerCase() || '';
            const posizione = item.children[2]?.textContent.toLowerCase() || '';

            const match = 
                nome.includes(searchText) &&
                (tipologia === '' || tipo === tipologia);

            item.style.display = match ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', filterAssets);
    tipologiaFilter.addEventListener('change', filterAssets);
});
</script>
{% endblock %}
