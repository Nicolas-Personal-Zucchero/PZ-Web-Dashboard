{% extends "base.html" %}
{% block title %}Asset{% endblock %}

{% block content %}
<div class="p-4">
    <a href="javascript:history.back()" class="btn btn-light mb-3">
      <i class="bi bi-arrow-left"></i> Torna indietro
    </a>
    <h1>Elenco Asset</h1>

    <!-- Pulsante mostra/nascondi form -->
    <button class="btn btn-info mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#formAsset" aria-expanded="false" aria-controls="formAsset" id="btnToggle">
        <i class="bi bi-plus-circle"></i> Aggiungi asset
    </button>

    <!-- Form per aggiunta asset -->
    <div class="collapse mb-4" id="formAsset">
        <form method="POST">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="nome" class="form-label">Nome dell'asset</label>
                    <input type="text" class="form-control" name="nome" id="nome" placeholder="Es: Macchina Zucchero 1" required>
                </div>
                <div class="col-md-4">
                    <label for="selectTipologia" class="form-label">Tipologia</label>
                    <select class="form-select" name="tipologia" id="selectTipologia" required>
                        <option value="" disabled selected></option>
                        <option>Macchina</option>
                        <option>Veicolo</option>
                        <option>Oggetto</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="posizione" class="form-label">Posizione</label>
                    <input type="text" class="form-control" name="posizione" id="posizione" placeholder="Es: Reparto produzione" required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="intervallo_manutenzione" class="form-label">Intervallo Manutenzione (giorni)</label>
                    <input type="number" class="form-control" name="intervallo_manutenzione" id="intervallo_manutenzione" placeholder="Es: 365" required>
                </div>
                <div class="col-md-4">
                    <label for="intervallo_pulizia" class="form-label">Intervallo Pulizia (giorni)</label>
                    <input type="number" class="form-control" name="intervallo_pulizia" id="intervallo_pulizia" placeholder="Es: 30" min="0" required>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Registra asset</button>
        </form>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} mt-2">{{ message }}</div>
        {% endfor %}
    {% endwith %}
    <hr>

    <!-- Filtro ricerca e tipologia -->
    {% if entries %}
    <!-- <h3>Asset presenti nel gestionale:</h3> -->

    <div class="mb-3 row g-2">
        <div class="col-md-6">
            <input type="text" class="form-control" id="searchInput" placeholder="Cerca asset">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="tipologiaFilter">
                <option value="">Tutte le tipologie</option>
                {% for t in entries|map(attribute='tipologia')|unique %}
                    <option value="{{ t }}">{{ t }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div style="max-height: 500px; overflow-y: auto;">
        <ul class="list-group" id="assetList">
            <!-- Header -->
            <li class="list-group-item bg-light fw-bold static-header">
                <div class="row">
                    <div class="col-md-2">Nome</div>
                    <div class="col-md-2">Tipologia</div>
                    <div class="col-md-2">Posizione</div>
                    <div class="col-md-2">Int. Manutenzione</div>
                    <div class="col-md-2">Int. Pulizia</div>
                    <div class="col-md-1 text-end">Apri</div>
                    <div class="col-md-1 text-end">Elimina</div>
                </div>
            </li>

            <!-- Asset entries -->
            {% for e in entries %}
            <li class="list-group-item">
                <div class="row">
                    <div class="col-md-2"><strong>{{ e.nome }}</strong></div>
                    <div class="col-md-2">{{ e.tipologia }}</div>
                    <div class="col-md-2">{{ e.posizione }}</div>
                    <div class="col-md-2">{{ e.intervallo_manutenzione }}</div>
                    <div class="col-md-2">{{ e.intervallo_pulizia }}</div>
                    <div class="col-md-1 text-end">
                        <a href="/wip/asset/{{ e.id }}" class="btn btn-primary btn-sm">Apri</a>
                    </div>
                    <div class="col-md-1 text-end">
                        <form method="POST" action="/wip/asset/elimina" 
                            onsubmit="return confirm('Sei sicuro di voler eliminare questo asset?');">
                            <input type="hidden" name="asset_id" value="{{ e.id }}">
                            <button type="submit" class="btn btn-danger btn-sm">Elimina</button>
                        </form>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>

    {% else %}
    <p class="text-muted">Nessun asset registrato.</p>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById('searchInput');
    const tipologiaFilter = document.getElementById('tipologiaFilter');
    const items = document.querySelectorAll('#assetList tr');

    function filterAssets() {
        const searchText = searchInput.value.toLowerCase();
        const tipologia = tipologiaFilter.value.toLowerCase();

        items.forEach(item => {
            const nome = item.children[0]?.textContent.toLowerCase() || '';
            const tipo = item.children[1]?.textContent.toLowerCase() || '';
            const posizione = item.children[2]?.textContent.toLowerCase() || '';

            const match = 
                nome.includes(searchText) &&
                (tipologia === '' || tipo === tipologia);

            item.style.display = match ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', filterAssets);
    tipologiaFilter.addEventListener('change', filterAssets);

    const toggleBtn = document.getElementById('btnToggle');
    const formCollapse = document.getElementById('formAsset');

    if (toggleBtn && formCollapse) {
        formCollapse.addEventListener('show.bs.collapse', () => {
            toggleBtn.innerHTML = '<i class="bi bi-x-circle"></i> Annulla';
        });

        formCollapse.addEventListener('hide.bs.collapse', () => {
            toggleBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Aggiungi Lotto';
        });
    }
});
</script>
{% endblock %}
